variables:
  BUILD_PATH: "dist"
  DEPLOY_HOST: "www@gailkirklandphotography.com"
  DEPLOY_PATH: "/var/www/gailkirklandphotography-www"
  DEPLOY_URL: "$DEPLOY_HOST:$DEPLOY_PATH"

  ANALYTICS: "true"
  NODE_ENV: production
  SERVER_SIDE_RENDERING: "true"

.build: &build
  cache: &build-cache
    paths:
      - $BUILD_PATH/*.js
      - node_modules
      - public
  script:
    - node --version
    - npm --version
    - npm prune --production=false
    - npm install
    - npm install --only=dev
    - npm list --depth=0
    - NODE_ENV= npm list --depth=0 --only=dev
    - npm run build
  stage: build
  tags:
    - docker-node

build:
  <<: *build
  except:
    - tags

build-tag:
  <<: *build
  artifacts:
    paths:
      - $BUILD_PATH
      - package.json
  cache:
    <<: *build-cache
    key: "$CI_BUILD_STAGE/tags"
  only:
    - tags

deploy:
  only:
    - tags
  script:
    - >-
      rsync
      --archive
      --compress
      --delete
      --itemize-changes
      --no-group
      --no-owner
      --relative
      -e ssh
      $BUILD_PATH
      .env.example
      package.json
      $DEPLOY_URL
  stage: deploy
  tags:
    - shell
